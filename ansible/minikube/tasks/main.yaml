# - name: Download cri-tools binary (crictl)
#   get_url:
#     url: https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.29.0/crictl-v1.29.0-linux-amd64.tar.gz
#     dest: /tmp/crictl.tar.gz

# - name: Extract crictl to /usr/local/bin
#   unarchive:
#     src: /tmp/crictl.tar.gz
#     dest: /usr/local/bin/
#     remote_src: yes

# - name: Ensure crictl is executable
#   file:
#     path: /usr/local/bin/crictl
#     mode: '0755'
#     state: file

# - name: Install required dependencies for Minikube
#   yum:
#     name:
#       - conntrack
#       - iptables
#       - socat
#       - ebtables
#     state: present

# - name: Verify conntrack is available in root's PATH
#   shell: which conntrack
#   register: conntrack_check
#   failed_when: conntrack_check.rc != 0
#   changed_when: false

# - name: Ensure Minikube binary is present
#   stat:
#     path: /usr/local/bin/minikube
#   register: minikube_stat

# - name: Download Minikube
#   get_url:
#     url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
#     dest: /usr/local/bin/minikube
#     mode: '0755'
#   when: not minikube_stat.stat.exists

# - name: Ensure minikube is callable
#   shell: /usr/local/bin/minikube version
#   register: minikube_version
#   ignore_errors: yes

# - name: Check for existing Minikube cluster
#   shell: /usr/local/bin/minikube profile list --output json
#   register: minikube_profiles
#   changed_when: false
#   ignore_errors: yes

# - name: Delete existing Minikube cluster if driver mismatch
#   shell: /usr/local/bin/minikube delete
#   when: >
#     minikube_profiles.stdout is defined and
#     ('"Driver":"none"' in minikube_profiles.stdout) and
#     ('"Name":"minikube"' in minikube_profiles.stdout)

# - name: Start Minikube with docker driver
#   shell: /usr/local/bin/minikube start --driver=docker --alsologtostderr -v=4
#   become: false
#   environment:
#     PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
#   args:
#     executable: /bin/bash
#   register: minikube_start

# - name: Debug Minikube output
#   debug:
#     var: minikube_start.stdout_lines
- name: Run docker command via newgrp
  become: false
  shell: |
    newgrp docker <<EOF
    docker info
    EOF


- name: Check if Minikube is already installed
  stat:
    path: /usr/local/bin/minikube
  register: minikube_stat

- name: Download Minikube
  get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: '0755'
  when: not minikube_stat.stat.exists

- name: Check if Minikube has been initialized
  stat:
    path: /home/{{ ansible_user }}/.minikube
  register: minikube_home

- name: Start Minikube with docker driver
  shell: sg docker -c "minikube start --driver=docker"
  become: false
  environment:
    PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  args:
    executable: /bin/bash
  when: not minikube_home.stat.exists

